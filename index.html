<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rotorz Garage 17 - System</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --dark-light: #374151;
            --light: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            background-color: var(--light); 
            color: var(--dark); 
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; 
        }

        /* --- LOGIN PAGE --- */
        #login-page {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            height: 100dvh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            padding: 20px;
            overflow: auto;
        }

        /* Efek Bercak dan Guratan dengan Tema Motor */
        #login-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 15% 25%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 85% 15%, rgba(245, 158, 11, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 35% 85%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(239, 68, 68, 0.1) 0%, transparent 50%),
                linear-gradient(90deg, transparent 40%, rgba(255, 255, 255, 0.05) 50%, transparent 60%),
                linear-gradient(0deg, transparent 30%, rgba(255, 255, 255, 0.05) 40%, transparent 50%);
            z-index: 0;
        }

        /* ANIMASI ICON BERJALAN */
        .login-floating-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .floating-icon {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: floatRandom 15s infinite linear;
        }

        @keyframes floatRandom {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.1;
            }
            25% {
                transform: translateY(-50px) translateX(50px) rotate(90deg);
                opacity: 0.15;
            }
            50% {
                transform: translateY(30px) translateX(-30px) rotate(180deg);
                opacity: 0.1;
            }
            75% {
                transform: translateY(-20px) translateX(-50px) rotate(270deg);
                opacity: 0.15;
            }
            100% {
                transform: translateY(0) translateX(0) rotate(360deg);
                opacity: 0.1;
            }
        }

        .login-box { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 1.5rem; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 400px;
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(0);
            animation: floatIn 0.6s ease-out;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
        }
        
        @keyframes floatIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-box h2 { 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem; 
            font-size: 1.3rem; 
        }
        
        .login-icon {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .form-group { 
            margin-bottom: 1.25rem; 
            text-align: left; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
            color: var(--dark); 
            font-size: 0.9rem; 
        }
        
        .form-control { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            font-size: 1rem; 
            transition: all 0.3s;
            background: var(--white);
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
        }

        .login-copyright {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* --- SCREEN SAVER --- */
        #screen-saver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            padding: 20px;
        }

        .pos-animation {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 5px;
            margin-bottom: 1rem;
            position: relative;
        }

        .pos-animation::after {
            content: 'Point Of Sale';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            letter-spacing: 3px;
            color: var(--secondary);
            margin-top: 10px;
            font-weight: 300;
        }

        .gear-animation {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 1rem;
        }

        .gear {
            position: absolute;
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.3);
            animation: rotateGear 10s linear infinite;
        }

        .gear:nth-child(1) {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            animation-direction: normal;
        }

        .gear:nth-child(2) {
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            animation-direction: reverse;
            animation-duration: 8s;
        }

        .gear:nth-child(3) {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            animation-duration: 12s;
        }

        .gear:nth-child(4) {
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            animation-direction: reverse;
            animation-duration: 15s;
        }

        @keyframes rotateGear {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .motor-icon-saver {
            position: absolute;
            font-size: 2rem;
            color: var(--warning);
            opacity: 0.7;
            animation: driveMotor 20s linear infinite;
        }

        @keyframes driveMotor {
            0% { left: -100px; transform: rotate(0deg); }
            25% { left: 25%; transform: rotate(5deg); }
            50% { left: 50%; transform: rotate(0deg); }
            75% { left: 75%; transform: rotate(-5deg); }
            100% { left: 100%; transform: rotate(0deg); }
        }

        .splash-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1rem;
            line-height: 1.6;
        }

        /* --- APP CONTAINER --- */
        #app-container { 
            display: none; 
            width: 100%; 
            height: 100vh;
            height: 100dvh;
            flex-direction: column;
        }
        
        /* Mobile Header */
        .mobile-header {
            display: none;
            background: linear-gradient(180deg, var(--dark) 0%, #111827 100%);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .mobile-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .mobile-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            min-width: 44px;
            min-height: 44px;
        }
        
        .mobile-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mobile-logo-icon {
            background: linear-gradient(135deg, var(--primary), #60a5fa);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mobile-logo-icon:hover {
            background: linear-gradient(135deg, var(--primary-dark), #3b82f6);
            transform: scale(1.05);
        }
        
        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        /* Sidebar untuk Semua Device */
        .sidebar { 
            width: 280px; 
            background: linear-gradient(180deg, var(--dark) 0%, #111827 100%); 
            color: var(--white); 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar-header { 
            padding: 1rem; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            background: rgba(0, 0, 0, 0.2);
        }
                
        .sidebar-logo { 
            background: white; /* Warna asli */
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sidebar-logo:hover { 
            background: white; /* Warna lebih gelap saat hover */
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* Efek saat sidebar collapsed - tetap warna asli */
        .sidebar.collapsed .sidebar-logo {
            border-radius: 50%;
            background: white; /* Tetap warna asli */
        }
        
        .sidebar-title { 
            font-size: 1rem; 
            font-weight: 700; 
            white-space: nowrap;
        }
        
        .close-sidebar {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            min-width: 44px;
            min-height: 44px;
        }
        
        /* User Info */
        .user-info { 
            padding: 1rem; 
            font-size: 0.85rem; 
            background: rgba(255, 255, 255, 0.05); 
            color: #9ca3af; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 10px;
        }
        
        .user-details { 
            flex: 1; 
            overflow: hidden; 
        }
        
        .user-name { 
            font-weight: 600; 
            color: white; 
            display: block; 
    font-size: 0.9rem; 
        }
        
        .user-role { 
            font-size: 0.75rem; 
            opacity: 0.8; 
        }
        
        .badge-owner { 
            background: linear-gradient(135deg, var(--warning), #fbbf24); 
            color: #fff; 
            padding: 3px 8px; 
            border-radius: 20px; 
            font-size: 0.65rem; 
            font-weight: 700;
            text-transform: uppercase;
        }
        
        /* Menu Styling */
        .menu { 
            flex: 1; 
            padding: 0.5rem 0; 
            overflow-y: auto; 
            overflow-x: hidden;
        }
        
        .menu-category { 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            color: #9ca3af; 
            padding: 1rem 1rem 0.5rem; 
            font-weight: 600; 
            letter-spacing: 0.5px;
        }
        
        .menu-item { 
            padding: 0.875rem 1rem; 
            cursor: pointer; 
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-left: 3px solid transparent;
            margin: 0 0.5rem;
            border-radius: 6px;
            min-height: 44px;
        }
        
        .menu-item:hover { 
            background: rgba(255, 255, 255, 0.05); 
            border-left-color: var(--primary);
        }
        
        .menu-item.active { 
            background: rgba(59, 130, 246, 0.15); 
            border-left-color: var(--primary);
            color: white;
        }
        
        .menu-item.active .menu-icon { 
            color: var(--primary); 
        }
        
        .menu-icon { 
            font-size: 1.1rem; 
            width: 20px; 
            text-align: center; 
        }
        
        .menu-label { 
            flex: 1; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .menu-arrow { 
            transition: transform 0.3s; 
            font-size: 0.8rem; 
            opacity: 0.7;
        }
        
        .menu-arrow.rotate { transform: rotate(90deg); }
        
        .menu-item.logout { 
            background: rgba(239, 68, 68, 0.1); 
            border-left-color: var(--danger);
            margin: 1rem;
            border-radius: 8px;
        }
        
        .submenu { 
            padding-left: 2rem; 
            background: rgba(0,0,0,0.1); 
            display: none;
            border-left: 1px solid rgba(255,255,255,0.05);
            margin-left: 2.5rem;
        }
        
        .submenu.open { display: block; }
        
        /* Main Content */
        .main-content { 
            flex: 1; 
            padding: 1rem; 
            overflow-y: auto; 
            background: var(--light);
            height: calc(100vh - 60px);
            height: calc(100dvh - 60px);
            -webkit-overflow-scrolling: touch;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Section Styling */
        .section { 
            display: none; 
            animation: fadeIn 0.4s ease-out; 
        }
        
        .section.active { display: block; }
        
        /* Headers */
        h2 { 
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem; 
            font-size: 1.5rem; 
            position: relative;
        }
        
        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        }
        
        h3 { font-size: 1rem; font-weight: 600; color: var(--dark); margin-bottom: 0.75rem; }
        h4 { font-size: 0.9rem; font-weight: 600; color: var(--dark-light); margin-bottom: 0.75rem; }

        /* Cards Grid */
        .card-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 1rem; 
            margin-bottom: 1.5rem; 
        }
        
        .card { 
            background: var(--white); 
            padding: 1rem; 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); 
        }
        
        .card h3 { 
            font-size: 0.85rem; 
            color: #6b7280; 
            margin-bottom: 0.5rem; 
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .card .value { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--dark); 
        }
        
        .card-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        .card-sales .card-icon { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .card-debt .card-icon { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .card-profit .card-icon { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }

        /* Tables */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 1rem 0;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            min-width: 600px;
            font-size: 0.85rem; 
            background: var(--white);
        }
        
        th, td { 
            padding: 0.75rem 0.5rem; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        
        th { 
            background: #f8fafc; 
            font-weight: 600; 
            color: var(--dark-light);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:last-child td { border-bottom: none; }
        
        tr:hover td { background: #f8fafc; }
        
        /* Status Badges */
        .status-lunas { 
            color: var(--secondary); 
            font-weight: 600; 
            background: #dcfce7; 
            padding: 0.25rem 0.5rem; 
            border-radius: 20px; 
            font-size: 0.7rem; 
            display: inline-block;
        }
        
        .status-belum { 
            color: var(--danger); 
            font-weight: 600; 
            background: #fee2e2; 
            padding: 0.25rem 0.5rem; 
            border-radius: 20px; 
            font-size: 0.7rem; 
            display: inline-block;
        }

        /* User Process Info */
        .user-process-info {
            font-size: 0.7rem;
            color: #6b7280;
            display: block;
            margin-top: 2px;
        }

        .user-process-badge {
            background: linear-gradient(135deg, #e0f2fe, #dbeafe);
            color: #1d4ed8;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            display: inline-block;
        }

        /* Filter Box */
        .filter-box { 
            background: white; 
            padding: 1rem; 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            margin-bottom: 1rem; 
            display: flex; 
            flex-direction: column;
            gap: 0.75rem; 
        }
        
        .filter-group { width: 100%; }
        .filter-label { font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; display: block; color: var(--dark-light); }

        /* Buttons */
        .btn { 
            padding: 0.75rem 1rem; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 600; 
            color: white; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 6px; 
            transition: all 0.3s;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        
        .btn-success { background: var(--secondary); }
        .btn-success:hover { background: #0da271; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        
        .btn-warning { background: var(--warning); }
        .btn-warning:hover { background: #e1900c; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        
        .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.8rem; min-height: 36px; }
        .btn-xs { padding: 0.25rem 0.5rem; font-size: 0.75rem; min-height: 32px; }
        .btn-block { width: 100%; }

        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Cart Layout */
        .cart-layout { 
            display: flex; 
            flex-direction: column;
            gap: 1rem; 
            margin: 1rem 0; 
        }
        
        .cart-items-container { 
            background: #f8fafc; 
            padding: 1rem; 
            border-radius: var(--radius); 
            border: 2px dashed var(--border); 
            max-height: 200px; 
            overflow-y: auto;
        }
        
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: white; 
            padding: 10px; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            border: 1px solid #eee; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .cart-item:hover { transform: translateX(5px); }
        
        .cart-total { 
            font-size: 1.5rem; 
            font-weight: 700; 
            text-align: right; 
            margin: 1rem 0; 
            color: var(--primary); 
        }

        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            backdrop-filter: blur(4px);
        }
        
        .modal-content { 
            background: var(--white); 
            padding: 1.5rem; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 1.5rem; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 1rem; 
        }
        
        .close-modal { 
            cursor: pointer; 
            font-size: 1.5rem; 
            color: #9ca3af;
            transition: color 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            min-width: 44px;
            min-height: 44px;
        }
        
        .close-modal:hover { 
            color: var(--danger); 
            background: #fef2f2;
        }

        /* Report Summary */
        .report-summary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 0.75rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Toast Notification */
        .toast {
            position: fixed; 
            bottom: 1rem; 
            left: 1rem;
            right: 1rem;
            max-width: 400px;
            margin: 0 auto;
            background: var(--dark); 
            color: white; 
            padding: 12px 16px;
            border-radius: var(--radius); 
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            opacity: 0; 
            transition: opacity 0.5s, transform 0.5s; 
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(20px);
        }
        
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .toast-icon {
            font-size: 1.2rem;
        }

        /* Table Input Styles */
        .table-input {
            width: 70px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .table-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .remarks-input {
            width: 120px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .remarks-display {
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .selisih-positive {
            color: var(--secondary);
            font-weight: bold;
        }
        
        .selisih-negative {
            color: var(--danger);
            font-weight: bold;
        }
        
        .selisih-zero {
            color: #6b7280;
        }

        /* Scrollbar Styling */
        *::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        *::-webkit-scrollbar-track {
            background: transparent;
        }
        
        *::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        
        /* Responsive Breakpoints */
        @media (min-width: 768px) {
            /* Tablet Styles */
            .card-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
            
            #section-dashboard-kasir .card-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .sidebar { 
                transform: translateX(0); 
                position: relative;
                left: 0;
            }
            
            .mobile-header { display: none; }
            .sidebar-overlay { display: none !important; }
            
            #app-container { 
                flex-direction: row; 
            }
            
            .main-content { 
                height: 100vh; 
                padding: 1.5rem; 
                margin-left: 280px;
            }
            
            .filter-box { 
                flex-direction: row; 
            }
            
            .report-summary {
                flex-direction: row;
            }
            
            .cart-layout { 
                grid-template-columns: 1fr 1fr; 
                display: grid;
            }
            
            .modal-content { 
                max-width: 800px; 
            }
        }
        
        @media (min-width: 1024px) {
            /* Desktop Styles */
            .mobile-header { display: none; }
            .sidebar-overlay { display: none !important; }
            
            .sidebar { 
                width: 280px; 
                position: fixed;
                left: 0;
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: 70px;
            }
            
            .sidebar.collapsed .sidebar-title,
            .sidebar.collapsed .user-details,
            .sidebar.collapsed .menu-label,
            .sidebar.collapsed .menu-arrow,
            .sidebar.collapsed .badge-owner,
            .sidebar.collapsed .close-sidebar,
            .sidebar.collapsed .menu-category,
            .sidebar.collapsed .submenu {
                display: none !important;
            }
            
            .sidebar.collapsed .menu-item {
                justify-content: center;
                padding: 0.875rem 0;
                margin: 0 0.25rem;
            }
            
            .sidebar.collapsed .menu-icon {
                margin: 0;
                font-size: 1.3rem;
            }
            
            .sidebar.collapsed .user-info {
                justify-content: center;
                padding: 1rem 0.5rem;
            }
            
            .sidebar.collapsed .user-avatar {
                margin-right: 0;
            }
            
            .main-content {
                margin-left: 280px;
                transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .sidebar.collapsed + .main-content {
                margin-left: 70px;
            }
            
            .close-sidebar { display: none; }
            
            #app-container { 
                flex-direction: row; 
            }
            
            .main-content { 
                height: 100vh; 
                padding: 2rem; 
            }
            
            .card-grid { 
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            }
            
            .table-container {
                min-width: auto;
            }
            
            table {
                min-width: auto;
            }
        }
        
        /* Mobile Styles (default) */
        @media (max-width: 767px) {
            .mobile-header { display: block; }
            
            .login-box { 
                padding: 1.25rem; 
            }
            
            .main-content { 
                padding: 0.75rem; 
                margin-left: 0 !important;
            }
            
            .modal-content { 
                padding: 1.25rem; 
                margin: 0.5rem; 
            }
            
            .card { 
                padding: 0.75rem; 
            }
            
            .btn { 
                padding: 0.625rem 0.875rem; 
            }
            
            h2 { 
                font-size: 1.25rem; 
            }
            
            .pos-animation {
                font-size: 3rem;
                letter-spacing: 3px;
            }
            
            .gear-animation {
                width: 120px;
                height: 120px;
            }
            
            .motor-silhouette { display: none; }
        }
        
        /* Portrait vs Landscape */
        @media (orientation: landscape) and (max-height: 600px) {
            .login-box { 
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .main-content { 
                padding: 0.5rem; 
            }
            
            .card { 
                padding: 0.5rem; 
            }
            
            .menu-item {
                padding: 0.5rem 1rem;
                min-height: 36px;
            }
        }
        
        /* Animations */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .w-full { width: 100%; }
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-right { text-align: right; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-align-center { display: flex; align-items: center; gap: 8px; }
        .clickable { cursor: pointer; color: var(--primary); font-weight: 600; transition: color 0.3s; }
        .clickable:hover { color: var(--primary-dark); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- LOGIN -->
    <div id="login-page">
        <div class="login-floating-icons" id="floating-icons"></div>
        <div class="login-box">
            <h2><span class="login-icon"><i class="fas fa-motorcycle"></i></span> Rotorz Garage 17</h2>
            <div class="form-group">
                <label><i class="fas fa-user"></i> Username</label>
                <select id="username" class="form-control">
                    <option value="owner">Owner</option>
                    <option value="mgr">Manager</option>
                    <option value="kasir">Kasir</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" class="form-control" value="1234">
            </div>
            <button class="btn btn-primary w-full" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Log In
            </button>
            
            <div class="login-copyright text-xs mt-2">
                Â© Powered By Kim Jong Un. All rights reserved 2026
            </div>
        </div>
    </div>

    <!-- SCREEN SAVER -->
    <div id="screen-saver">
        <div class="gear-animation">
            <div class="gear"><i class="fas fa-cog"></i></div>
            <div class="gear"><i class="fas fa-cog"></i></div>
            <div class="gear"><i class="fas fa-cog"></i></div>
            <div class="gear"><i class="fas fa-cog"></i></div>
        </div>
        <div class="pos-animation">P.O.S</div>
        <div class="motor-icon-saver"><i class="fas fa-motorcycle"></i></div>
        <div class="splash-text">
            Sistem Manajemen Bengkel Motor - Rotorz Garage 17
            <br>Ready to serve your motorcycle needs
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="mobile-header-content">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="mobile-logo">
                    <div class="mobile-logo-icon" onclick="toggleSidebarDesktop()">
                        <i class="fas fa-motorcycle"></i>
                    </div>
                    <span class="sidebar-title">ROTORZ GARAGE</span>
                </div>
                <div class="user-avatar-small" id="mobile-user-avatar">U</div>
            </div>
        </div>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo clickable" onclick="toggleSidebarDesktop()" title="Toggle Sidebar">
                    <i class="fas fa-motorcycle" id="sidebar-toggle-icon"></i>
                </div>
                <div class="sidebar-title">ROTORZ GARAGE 17</div>
                <button class="close-sidebar" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="user-info">
                <div class="flex items-center">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-details">
                        <span class="user-name" id="display-username">User</span>
                        <span class="user-role" id="display-role">Role</span>
                    </div>
                </div>
                <span id="role-badge"></span>
            </div>
            
            <div class="menu" id="menu-list">
                <!-- Menu akan di-generate oleh JavaScript -->
            </div>
            
            <div class="menu-item logout" onclick="handleLogout()">
                <span class="menu-icon"><i class="fas fa-sign-out-alt"></i></span>
                <span class="menu-label">Log Out</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- 1. DASHBOARD -->
            <div id="section-dashboard" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
                    <button class="btn btn-primary btn-sm" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-grid">
                    <div class="card card-sales">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3>Total Penjualan</h3>
                                <div class="value" id="dash-sales">Rp 0</div>
                            </div>
                            <div class="card-icon"><i class="fas fa-coins"></i></div>
                        </div>
                    </div>
                    <div class="card card-debt">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3>Piutang</h3>
                                <div class="value" id="dash-receivable">Rp 0</div>
                            </div>
                            <div class="card-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        </div>
                    </div>
                    <div class="card card-profit">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3>Laba Bersih</h3>
                                <div class="value" id="dash-profit">Rp 0</div>
                            </div>
                            <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                        </div>
                    </div>
                </div>
                <div class="card mt-2">
                    <h3><i class="fas fa-clock"></i> Tagihan Belum Lunas</h3>
                    <div class="table-container">
                        <table id="table-due-receivables">
                            <thead>
                                <tr>
                                    <th>Pelanggan</th>
                                    <th>Total</th>
                                    <th>Tgl</th>
                                    <th>Proses Oleh</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. DASHBOARD KASIR -->
            <div id="section-dashboard-kasir" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-cash-register"></i> Dashboard Kasir</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="openTransaction()">
                            <i class="fas fa-plus"></i> Baru
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="refreshAllData()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-grid">
                    <div class="card card-sales">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3>Penjualan Hari Ini</h3>
                                <div class="value" id="dash-sales-today">Rp 0</div>
                            </div>
                            <div class="card-icon"><i class="fas fa-coins"></i></div>
                        </div>
                    </div>
                    <div class="card card-debt">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3>Piutang Aktif</h3>
                                <div class="value" id="dash-receivable-active">Rp 0</div>
                            </div>
                            <div class="card-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        </div>
                    </div>
                    <div class="card card-profit">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3>Transaksi Hari Ini</h3>
                                <div class="value" id="dash-transactions-today">0</div>
                            </div>
                            <div class="card-icon"><i class="fas fa-cash-register"></i></div>
                        </div>
                    </div>
                </div>
                <div class="card mt-2">
                    <h3><i class="fas fa-clock"></i> Tagihan Belum Lunas</h3>
                    <div class="table-container">
                        <table id="table-due-receivables-kasir">
                            <thead>
                                <tr>
                                    <th>Pelanggan</th>
                                    <th>No. Trans</th>
                                    <th>Total</th>
                                    <th>Tgl Jatuh Tempo</th>
                                    <th>Proses Oleh</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. STOK & PEMBELIAN -->
            <div id="section-inventory" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-boxes"></i> Stok & Pembelian</h2>
                    <button class="btn btn-success btn-sm" onclick="openPurchaseModal()">
                        <i class="fas fa-plus"></i> Beli
                    </button>
                </div>
                <div class="card">
                    <small class="text-xs" style="color:#666; margin-bottom:10px; display:block;">
                        <i class="fas fa-info-circle"></i> Klik nama barang untuk detail
                    </small>
                    <div class="table-container">
                        <table id="table-inventory">
                            <thead>
                                <tr>
                                    <th>Nama Barang</th>
                                    <th>Stok</th>
                                    <th>HPP</th>
                                    <th>Harga Jual</th>
                                    <th>Margin</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. PENJUALAN -->
            <div id="section-pos" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-shopping-cart"></i> Penjualan</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="openTransaction()">
                            <i class="fas fa-plus"></i> Transaksi
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportTableToExcel('table-pos-history', 'Laporan_Penjualan')">
                            <i class="fas fa-file-excel"></i>
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table id="table-pos-history">
                            <thead>
                                <tr>
                                    <th>Tgl</th>
                                    <th>ID</th>
                                    <th>Pelanggan</th>
                                    <th>Item</th>
                                    <th>Total</th>
                                    <th>Metode</th>
                                    <th>Status</th>
                                    <th>Proses Oleh</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. LAPORAN PEMBELIAN -->
            <div id="section-report-purchase" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-shopping-bag"></i> Laporan Pembelian</h2>
                    <button class="btn btn-success btn-sm" onclick="exportTableToExcel('table-purchase-report', 'Laporan_Pembelian')">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                </div>
                <div class="card">
                    <div class="filter-box">
                        <div class="filter-group">
                            <label class="filter-label">Dari Tanggal</label>
                            <input type="date" id="pur-filter-start" class="form-control" onchange="renderPurchaseReport()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Sampai Tanggal</label>
                            <input type="date" id="pur-filter-end" class="form-control" onchange="renderPurchaseReport()">
                        </div>
                    </div>
                    
                    <div class="report-summary">
                        <div class="summary-item">
                            <div class="summary-label">Total Pembelian</div>
                            <div class="summary-value" id="total-purchase-summary">Rp 0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Qty</div>
                            <div class="summary-value" id="total-purchase-qty">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Barang</div>
                            <div class="summary-value" id="total-purchase-items">0</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="table-purchase-report">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Barang</th>
                                    <th>Qty</th>
                                    <th>HPP</th>
                                    <th>Total Modal</th>
                                    <th>Metode</th>
                                    <th>Proses Oleh</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. LAPORAN PENJUALAN -->
            <div id="section-report-sales" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-chart-bar"></i> Laporan Penjualan</h2>
                    <button class="btn btn-success btn-sm" onclick="exportTableToExcel('table-sales-report', 'Laporan_Penjualan')">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                </div>
                <div class="card">
                    <div class="filter-box">
                        <div class="filter-group">
                            <label class="filter-label">Dari Tanggal</label>
                            <input type="date" id="sales-filter-start" class="form-control" onchange="renderSalesReport()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Sampai Tanggal</label>
                            <input type="date" id="sales-filter-end" class="form-control" onchange="renderSalesReport()">
                        </div>
                    </div>
                    
                    <div class="report-summary">
                        <div class="summary-item">
                            <div class="summary-label">Total Penjualan</div>
                            <div class="summary-value" id="total-sales-summary">Rp 0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Kredit</div>
                            <div class="summary-value" id="total-credit-summary">Rp 0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Transaksi</div>
                            <div class="summary-value" id="total-transactions-summary">0</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="table-sales-report">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>No. Invoice</th>
                                    <th>Pelanggan</th>
                                    <th>Item</th>
                                    <th>Metode</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Proses Oleh</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 7. LAPORAN MUTASI -->
            <div id="section-opname" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-exchange-alt"></i> Mutasi Stok</h2>
                    <button class="btn btn-success btn-sm" onclick="exportTableToExcel('table-opname', 'Laporan_Mutasi_Stok')">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                </div>
                <div class="card">
                    <div class="filter-box">
                        <div class="filter-group">
                            <label class="filter-label">Dari Tanggal</label>
                            <input type="date" id="filter-start" class="form-control" onchange="renderMutationReport()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Sampai Tanggal</label>
                            <input type="date" id="filter-end" class="form-control" onchange="renderMutationReport()">
                        </div>
                    </div>
                    <small class="text-xs" style="display:block; margin-bottom:10px; color:#666;">
                        <i class="fas fa-info-circle"></i> Masukkan nilai Actual setelah pengecekan fisik stok. <br>
                        <span style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> Selisih negatif akan otomatis dicatat sebagai beban biaya loss.</span>
                    </small>
                    <div class="table-container">
                        <table id="table-opname">
                            <thead>
                                <tr>
                                    <th>Barang</th>
                                    <th>Stok Awal</th>
                                    <th style="color:var(--success)">Masuk</th>
                                    <th style="color:var(--danger)">Keluar</th>
                                    <th>Stok Sistem</th>
                                    <th>Actual</th>
                                    <th>Selisih</th>
                                    <th>Remarks</th>
                                    <th>Proses Oleh</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 8. DETAIL MUTASI STOK -->
            <div id="section-mutation-detail" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-list-alt"></i> Detail Mutasi</h2>
                    <button class="btn btn-primary btn-sm" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card">
                    <div class="filter-box">
                        <div class="filter-group">
                            <label class="filter-label">Dari Tanggal</label>
                            <input type="date" id="detail-filter-start" class="form-control" onchange="renderMutationDetail()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Sampai Tanggal</label>
                            <input type="date" id="detail-filter-end" class="form-control" onchange="renderMutationDetail()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filter Barang</label>
                            <select id="detail-filter-item" class="form-control" onchange="renderMutationDetail()">
                                <option value="">Semua Barang</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="table-mutation-detail">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Barang</th>
                                    <th>Tipe</th>
                                    <th>Referensi</th>
                                    <th>Qty</th>
                                    <th>Stok Sebelum</th>
                                    <th>Stok Sesudah</th>
                                    <th>Proses Oleh</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 9. BEBAN BIAYA -->
            <div id="section-expenses" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-money-bill-wave"></i> Beban Biaya</h2>
                    <button class="btn btn-danger btn-sm" onclick="openExpenseModal()">
                        <i class="fas fa-plus"></i> Tambah
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table id="table-expenses">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Keterangan</th>
                                    <th>Nominal</th>
                                    <th>Proses Oleh</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 10. LABA RUGI -->
            <div id="section-reports" class="section">
                <h2><i class="fas fa-calculator"></i> Laporan Laba Rugi</h2>
                <div class="card" style="max-width: 100%;">
                    <table style="width: 100%;">
                        <tr><td><i class="fas fa-money-bill-trend-up"></i> PENDAPATAN</td><td class="text-right" id="report-revenue">Rp 0</td></tr>
                        <tr><td style="padding-left:20px;"><i class="fas fa-minus"></i> HPP</td><td class="text-right" id="report-cogs">Rp 0</td></tr>
                        <tr style="background:#f0fdf4; font-weight:bold;"><td><i class="fas fa-equals"></i> LABA KOTOR</td><td class="text-right" id="report-gross">Rp 0</td></tr>
                        <tr><td><i class="fas fa-minus"></i> BEBAN OPERASIONAL</td><td class="text-right" id="report-expenses">Rp 0</td></tr>
                        <tr style="background:#ecfccb; font-weight:bold; font-size:1.1rem;">
                            <td><i class="fas fa-equals"></i> LABA BERSIH</td>
                            <td class="text-right" id="report-net">Rp 0</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- 11. USER MANAGEMENT -->
            <div id="section-users" class="section">
                <div class="flex justify-between items-center mb-2">
                    <h2><i class="fas fa-users-cog"></i> Manajemen User</h2>
                    <button class="btn btn-primary btn-sm" onclick="openUserModal()">
                        <i class="fas fa-plus"></i> Tambah
                    </button>
                </div>
                <div class="card">
                    <div class="table-container">
                        <table id="table-users">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Nama</th>
                                    <th>Role</th>
                                    <th>Proses Oleh</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">
        <span class="toast-icon"><i class="fas fa-check-circle"></i></span>
        <span class="toast-message">Action Successful</span>
    </div>

    <!-- MODALS -->
    
    <!-- MODAL TRANSAKSI -->
    <div id="modal-transaction" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cash-register"></i> Transaksi Baru</h3>
                <span class="close-modal" onclick="closeModal('modal-transaction')">&times;</span>
            </div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> Nama Pelanggan</label>
                <input type="text" id="trx-customer" class="form-control" placeholder="Nama pelanggan...">
            </div>
            <div class="cart-layout">
                <div>
                    <h4><i class="fas fa-cart-plus"></i> Tambah Item</h4>
                    <div class="form-group">
                        <label><i class="fas fa-search"></i> Cari Barang</label>
                        <input type="text" id="trx-search" class="form-control" placeholder="Ketik nama barang..." oninput="filterProductOptions()">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> Pilih Barang</label>
                        <select id="trx-item" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-hashtag"></i> Jumlah</label>
                        <input type="number" id="trx-qty" class="form-control" value="1" min="1">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="addToCart()">
                        <i class="fas fa-plus"></i> Tambah ke Keranjang
                    </button>
                </div>
                <div>
                    <h4><i class="fas fa-shopping-cart"></i> Keranjang</h4>
                    <div id="cart-container" class="cart-items-container"></div>
                    <div class="cart-total" id="cart-total-display">Total: Rp 0</div>
                </div>
            </div>
            <div class="form-group">
                <label><i class="fas fa-credit-card"></i> Metode Pembayaran</label>
                <select id="trx-method" class="form-control" onchange="togglePaymentInput()">
                    <option value="cash">Lunas (Cash)</option>
                    <option value="credit">Kredit (Bayar Nanti)</option>
                </select>
            </div>
            <div id="cash-payment-section" class="payment-box" style="background: #eff6ff; padding: 1rem; border-radius: 8px; border: 1px solid #bfdbfe; margin-top: 1rem;">
                <div class="form-group">
                    <label><i class="fas fa-money-bill-wave"></i> Uang Diterima (Rp)</label>
                    <input type="number" id="trx-cash-received" class="form-control" placeholder="Masukkan uang tunai..." oninput="calculateChange()">
                </div>
                <div class="change-display" id="change-display" style="font-size: 1.2rem; font-weight: bold; color: var(--success); text-align: right; margin-top: 0.5rem;">Kembalian: Rp 0</div>
            </div>
            <button class="btn btn-success btn-block mt-2" onclick="submitTransaction()">
                <i class="fas fa-check"></i> Proses Transaksi
            </button>
        </div>
    </div>

    <!-- MODAL PEMBELIAN -->
    <div id="modal-purchase" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-box-open"></i> Stok Masuk</h3>
                <span class="close-modal" onclick="closeModal('modal-purchase')">&times;</span>
            </div>
            <div class="form-group">
                <label><i class="fas fa-box"></i> Pilih Barang</label>
                <select id="pur-item-type" class="form-control" onchange="toggleNewItemInput()">
                    <option value="existing">Barang yang Sudah Ada</option>
                    <option value="new">Input Barang Baru</option>
                </select>
            </div>
            <div id="pur-existing-group" class="form-group">
                <label><i class="fas fa-search"></i> Cari Barang</label>
                <select id="pur-item" class="form-control"></select>
            </div>
            <div id="pur-new-group" class="hidden">
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Nama Barang Baru</label>
                    <input type="text" id="pur-new-name" class="form-control" placeholder="Contoh: Shockbreaker Belakang">
                </div>
            </div>
            <div id="pur-edit-name-group" class="form-group hidden">
                <label><i class="fas fa-edit"></i> Edit Nama Barang</label>
                <input type="text" id="pur-edit-name" class="form-control" placeholder="Kosongkan jika tidak mengubah nama">
            </div>
            <div class="form-group">
                <label><i class="fas fa-hashtag"></i> Jumlah Masuk</label>
                <input type="number" id="pur-qty" class="form-control">
            </div>
            <div class="form-group">
                <label><i class="fas fa-money-bill"></i> Harga Beli (HPP)</label>
                <input type="number" id="pur-cost" class="form-control">
            </div>
            <div class="form-group">
                <label><i class="fas fa-chart-line"></i> Margin</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="pur-margin-amount" class="form-control" placeholder="Rp">
                    <input type="number" id="pur-margin-percent" class="form-control" placeholder="%">
                </div>
            </div>
            <div style="background:#f0fdf4; padding:10px; border-radius:4px; margin-bottom:10px;">
                <strong><i class="fas fa-eye"></i> Harga Jual:</strong> <span id="pur-preview-price">Rp 0</span>
            </div>
            <button class="btn btn-success btn-block" onclick="submitPurchase()">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>

    <!-- MODAL USER -->
    <div id="modal-user" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Tambah / Edit User</h3>
                <span class="close-modal" onclick="closeModal('modal-user')">&times;</span>
            </div>
            <input type="hidden" id="user-id">
            <div class="form-group">
                <label><i class="fas fa-id-card"></i> Nama Lengkap</label>
                <input type="text" id="user-fullname" class="form-control">
            </div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> Username</label>
                <input type="text" id="user-username" class="form-control">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="user-password" class="form-control">
            </div>
            <div class="form-group">
                <label><i class="fas fa-user-tag"></i> Role</label>
                <select id="user-role" class="form-control">
                    <option value="manager">Manager</option>
                    <option value="cashier">Kasir</option>
                    <option value="owner">Owner</option>
                </select>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveUser()">
                <i class="fas fa-save"></i> Simpan User
            </button>
        </div>
    </div>

    <!-- MODAL DETAIL BARANG -->
    <div id="modal-item-detail" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detail-item-name"><i class="fas fa-info-circle"></i> Detail Barang</h3>
                <span class="close-modal" onclick="closeModal('modal-item-detail')">&times;</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="card">
                    <h3><i class="fas fa-info"></i> Info Saat Ini</h3>
                    <p>Stok: <strong id="detail-stock" style="font-size:1.2rem">0</strong></p>
                    <p>HPP: <strong id="detail-cost">Rp 0</strong></p>
                    <p>Jual: <strong id="detail-price">Rp 0</strong></p>
                    <p>Margin: <strong id="detail-margin" style="color:var(--success)">Rp 0</strong></p>
                </div>
                <div class="card">
                    <h3><i class="fas fa-edit"></i> Update Cepat</h3>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Ubah Harga Jual</label>
                        <input type="number" id="detail-edit-price" class="form-control">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-plus"></i> Tambah Stok (+)</label>
                        <input type="number" id="detail-edit-stock" class="form-control" placeholder="0 jika tidak ada stok masuk">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="saveQuickEdit()">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
            <hr style="margin: 1rem 0;">
            <h3><i class="fas fa-history"></i> Riwayat Transaksi</h3>
            <div style="max-height: 200px; overflow-y: auto;">
                <table style="font-size:0.85rem; width:100%;">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Tipe</th>
                            <th>Ket/Ref</th>
                            <th>Masuk</th>
                            <th>Keluar</th>
                            <th>Sisa Stok</th>
                            <th>Proses Oleh</th>
                        </tr>
                    </thead>
                    <tbody id="detail-history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL DETAIL OUT (Mutasi) -->
    <div id="modal-mutation-detail" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-box-open"></i> Detail Pengeluaran</h3>
                <span class="close-modal" onclick="closeModal('modal-mutation-detail')">&times;</span>
            </div>
            <div class="card">
                <h3 id="mut-item-name">Nama Barang</h3>
                <p>Total Keluar: <strong id="mut-total-out" style="font-size:1.2rem; color:var(--danger)">0</strong> Unit</p>
            </div>
            <h4><i class="fas fa-list"></i> Daftar Transaksi:</h4>
            <div id="mut-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 10px;"></div>
        </div>
    </div>

    <!-- MODAL EXPENSE -->
    <div id="modal-expense" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> Catat Biaya</h3>
                <span class="close-modal" onclick="closeModal('modal-expense')">&times;</span>
            </div>
            <div class="form-group">
                <label><i class="fas fa-sticky-note"></i> Keterangan</label>
                <input type="text" id="exp-desc" class="form-control">
            </div>
            <div class="form-group">
                <label><i class="fas fa-money-bill"></i> Nominal</label>
                <input type="number" id="exp-amount" class="form-control">
            </div>
            <button class="btn btn-danger btn-block" onclick="submitExpense()">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>

<script>
// --- DATA & STATE dengan LOCAL STORAGE ---
let users = JSON.parse(localStorage.getItem('rotorz_users')) || [
    { id: 1, username: 'owner', password: '1234', role: 'owner', name: 'Pak Owner' },
    { id: 2, username: 'mgr', password: '1234', role: 'manager', name: 'Pak Manager' },
    { id: 3, username: 'kasir', password: '1234', role: 'cashier', name: 'Mbak Kasir' }
];

let inventory = JSON.parse(localStorage.getItem('rotorz_inventory')) || [
    { id: 1, name: 'Oli Mesin 1L', stock: 10, cost: 45000, price: 60000 },
    { id: 2, name: 'Kampas Rem Depan', stock: 5, cost: 150000, price: 200000 },
    { id: 3, name: 'Jasa Service Ringan', stock: 999, cost: 10000, price: 25000 }, 
    { id: 4, name: 'Busi Iridium', stock: 8, cost: 25000, price: 40000 }
];

let transactions = JSON.parse(localStorage.getItem('rotorz_transactions')) || []; 
let expenses = JSON.parse(localStorage.getItem('rotorz_expenses')) || []; 
let purchases = JSON.parse(localStorage.getItem('rotorz_purchases')) || []; 
let stockOpname = JSON.parse(localStorage.getItem('rotorz_stockOpname')) || [];

let currentUser = null;
let currentCart = [];
let idleTimer = null;
let screenSaverActive = false;

// --- FLOATING ICONS ---
function createFloatingIcons() {
    const icons = [
        'fas fa-motorcycle',
        'fas fa-wrench',
        'fas fa-oil-can',
        'fas fa-cog',
        'fas fa-tools',
        'fas fa-tire',
        'fas fa-key',
        'fas fa-shopping-cart',
        'fas fa-chart-line',
        'fas fa-bolt',
        'fas fa-gas-pump',
        'fas fa-car-battery'
    ];
    
    const container = document.getElementById('floating-icons');
    if (!container) return;
    
    container.innerHTML = '';
    
    icons.forEach(icon => {
        const iconElement = document.createElement('div');
        iconElement.className = `floating-icon ${icon}`;
        iconElement.style.left = `${Math.random() * 100}%`;
        iconElement.style.top = `${Math.random() * 100}%`;
        iconElement.style.animationDelay = `${Math.random() * 5}s`;
        iconElement.style.fontSize = `${Math.random() * 2 + 1}rem`;
        container.appendChild(iconElement);
    });
}

// --- LOCAL STORAGE FUNCTIONS ---
function saveToLocalStorage() {
    try {
        localStorage.setItem('rotorz_users', JSON.stringify(users));
        localStorage.setItem('rotorz_inventory', JSON.stringify(inventory));
        localStorage.setItem('rotorz_transactions', JSON.stringify(transactions));
        localStorage.setItem('rotorz_expenses', JSON.stringify(expenses));
        localStorage.setItem('rotorz_purchases', JSON.stringify(purchases));
        localStorage.setItem('rotorz_stockOpname', JSON.stringify(stockOpname));
        console.log('Data berhasil disimpan ke Local Storage');
    } catch (e) {
        console.error('Error menyimpan ke Local Storage:', e);
        showToast("Error menyimpan data!", "error");
    }
}

// --- SIDEBAR TOGGLE FUNCTIONS ---
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const isMobile = window.innerWidth <= 767;
    
    if (isMobile) {
        // Mobile behavior
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        if (sidebar.classList.contains('active')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = 'auto';
        }
    } else {
        // Desktop behavior - sama seperti mobile (slide in/out)
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
}

function toggleSidebarDesktop() {
    const sidebar = document.getElementById('sidebar');
    const toggleIcon = document.getElementById('sidebar-toggle-icon');
    
    if (window.innerWidth >= 1024) {
        sidebar.classList.toggle('collapsed');
        
        // ICON TETAP SAMA - TIDAK BERUBAH
        // Biarkan ikon tetap fa-motorcycle baik saat collapsed maupun expanded
        toggleIcon.className = 'fas fa-motorcycle';
    } else {
        // Untuk mobile, tetap gunakan toggle biasa
        toggleSidebar();
    }
}

function closeMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = 'auto';
}

// --- IDLE DETECTION & SCREEN SAVER ---
function resetIdleTimer() {
    clearTimeout(idleTimer);
    if (screenSaverActive) {
        hideScreenSaver();
    }
    
    idleTimer = setTimeout(showScreenSaver, 180000);
}

function showScreenSaver() {
    if (currentUser && currentUser.role === 'cashier') {
        screenSaverActive = true;
        document.getElementById('screen-saver').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
}

function hideScreenSaver() {
    screenSaverActive = false;
    document.getElementById('screen-saver').style.display = 'none';
    if (currentUser) {
        document.getElementById('app-container').style.display = 'flex';
    }
}

// Event listeners untuk reset idle timer
document.addEventListener('mousemove', resetIdleTimer);
document.addEventListener('keydown', resetIdleTimer);
document.addEventListener('click', resetIdleTimer);
document.addEventListener('touchstart', resetIdleTimer);

// --- AUTH ---
function handleLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    const user = users.find(x => x.username === u && x.password === p);
    
    if (user) {
        currentUser = user;
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('display-username').innerText = user.name;
        document.getElementById('display-role').innerText = user.role.toUpperCase();
        
        // Set avatar
        const avatar = document.getElementById('user-avatar');
        avatar.innerText = user.name.charAt(0).toUpperCase();
        
        // Set mobile avatar
        const mobileAvatar = document.getElementById('mobile-user-avatar');
        mobileAvatar.innerText = user.name.charAt(0).toUpperCase();
        
        // Set role badge
        const roleBadge = document.getElementById('role-badge');
        if (user.role === 'owner') {
            roleBadge.innerHTML = '<span class="badge-owner">SUPER ADMIN</span>';
        } else {
            roleBadge.innerHTML = '';
        }
        
        initApp();
        resetIdleTimer();
        showToast("Login berhasil!", "success");
    } else { 
        showToast("Username atau password salah!", "error");
    }
}

function handleLogout() {
    clearTimeout(idleTimer);
    saveToLocalStorage();
    currentUser = null;
    document.getElementById('app-container').style.display = 'none';
    document.getElementById('login-page').style.display = 'flex';
    showToast("Anda telah logout", "info");
}

// --- MENU & NAV ---
function initApp() {
    const menuList = document.getElementById('menu-list');
    menuList.innerHTML = '';
    
    let menuStructure = [];

    // 1. Dashboard
    menuStructure.push({ 
        id: 'dashboard', 
        label: currentUser.role === 'cashier' ? 'Dashboard Kasir' : 'Dashboard',
        icon: currentUser.role === 'cashier' ? 'fas fa-cash-register' : 'fas fa-chart-line',
        iconColor: currentUser.role === 'cashier' ? '#10b981' : '#3b82f6'
    });
    
    // 2. Stok (Owner & Mgr)
    if (currentUser.role === 'owner' || currentUser.role === 'manager') {
        menuStructure.push({ 
            id: 'inventory', 
            label: 'Stok & Pembelian', 
            icon: 'fas fa-boxes',
            iconColor: '#10b981'
        });
    }

    // 3. Penjualan (Semua)
    menuStructure.push({ 
        id: 'pos', 
        label: 'Penjualan', 
        icon: 'fas fa-shopping-cart',
        iconColor: '#8b5cf6'
    });

    // 4. Laporan Folder (Owner & Mgr)
    if (currentUser.role === 'owner' || currentUser.role === 'manager') {
        menuStructure.push({ 
            id: 'reports-folder', 
            label: 'Laporan', 
            icon: 'fas fa-folder-open',
            iconColor: '#f59e0b',
            isFolder: true,
            children: [
                { id: 'report-purchase', label: 'Pembelian', icon: 'fas fa-shopping-bag' },
                { id: 'report-sales', label: 'Penjualan', icon: 'fas fa-chart-bar' },
                { id: 'opname', label: 'Mutasi Stok', icon: 'fas fa-exchange-alt' },
                { id: 'mutation-detail', label: 'Detail Mutasi', icon: 'fas fa-list-alt' }
            ]
        });
    }

    // 5. Beban Biaya (Owner Only)
    if (currentUser.role === 'owner') {
        menuStructure.push({ 
            id: 'expenses', 
            label: 'Beban Biaya', 
            icon: 'fas fa-money-bill-wave',
            iconColor: '#ef4444'
        });
    }

    // 6. Laba Rugi (Owner Only)
    if (currentUser.role === 'owner') {
        menuStructure.push({ 
            id: 'reports', 
            label: 'Laba Rugi', 
            icon: 'fas fa-calculator',
            iconColor: '#06b6d4'
        });
    }

    // 7. User Management (Owner Only)
    if (currentUser.role === 'owner') {
        menuStructure.push({ 
            id: 'users', 
            label: 'Manajemen User', 
            icon: 'fas fa-users-cog',
            iconColor: '#8b5cf6'
        });
    }

    // Render Menus
    menuStructure.forEach(menu => {
        if(menu.isFolder) {
            const folderDiv = document.createElement('div');
            folderDiv.innerHTML = `
                <div class="menu-item" onclick="toggleSubmenu('submenu-${menu.id}')">
                    <span class="menu-icon" style="color:${menu.iconColor}"><i class="${menu.icon}"></i></span>
                    <span class="menu-label">${menu.label}</span>
                    <span class="menu-arrow">âº</span>
                </div>
            `;
            const subUl = document.createElement('div');
            subUl.id = `submenu-${menu.id}`;
            subUl.className = 'submenu';
            
            menu.children.forEach(sub => {
                const subItem = document.createElement('div');
                subItem.className = 'menu-item';
                subItem.innerHTML = `
                    <span class="menu-icon"><i class="${sub.icon}"></i></span>
                    <span class="menu-label">${sub.label}</span>
                `;
                subItem.onclick = () => showSection(sub.id, subItem);
                subUl.appendChild(subItem);
            });

            folderDiv.appendChild(subUl);
            menuList.appendChild(folderDiv);

        } else {
            const item = document.createElement('div');
            item.className = 'menu-item';
            item.innerHTML = `
                <span class="menu-icon" style="color:${menu.iconColor}"><i class="${menu.icon}"></i></span>
                <span class="menu-label">${menu.label}</span>
            `;
            item.onclick = () => showSection(menu.id, item);
            menuList.appendChild(item);
        }
    });

    // Tampilkan mobile header jika di mobile
    if (window.innerWidth <= 767) {
        document.querySelector('.mobile-header').style.display = 'block';
    } else {
        // Desktop - sidebar sudah terbuka
        document.getElementById('sidebar').classList.add('active');
    }

    // Default Active
    const firstItem = menuList.querySelector('.menu-item'); 
    if(firstItem) showSection('dashboard', firstItem);
    refreshAllData();
}

function toggleSubmenu(id) {
    const el = document.getElementById(id);
    const arrow = el.previousElementSibling.querySelector('.menu-arrow');
    el.classList.toggle('open');
    arrow.classList.toggle('rotate');
}

function showSection(id, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    let targetId = id;
    if (id === 'dashboard' && currentUser.role === 'cashier') targetId = 'dashboard-kasir';
    
    document.getElementById(`section-${targetId}`).classList.add('active');
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    if(el) el.classList.add('active');
    
    // Tutup sidebar di mobile
    if (window.innerWidth <= 767) {
        closeMobileSidebar();
    }
    
    refreshAllData();
    resetIdleTimer();
}

// --- USER MANAGEMENT ---
function openUserModal() {
    document.getElementById('user-id').value = '';
    document.getElementById('user-fullname').value = '';
    document.getElementById('user-username').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = 'manager';
    document.getElementById('modal-user').style.display = 'flex';
}

function saveUser() {
    const id = document.getElementById('user-id').value;
    const fullname = document.getElementById('user-fullname').value;
    const username = document.getElementById('user-username').value;
    const password = document.getElementById('user-password').value;
    const role = document.getElementById('user-role').value;

    if(!fullname || !username || !password) {
        showToast("Isi semua data!", "error");
        return;
    }
    
    if(!id && users.find(u => u.username === username)) {
        showToast("Username sudah ada!", "error");
        return;
    }

    if(id) {
        const u = users.find(x => x.id == id);
        u.name = fullname;
        u.username = username;
        u.password = password;
        u.role = role;
        u.updatedBy = currentUser.username;
        u.updatedDate = new Date().toISOString();
        showToast("User berhasil diupdate!", "success");
    } else {
        users.push({
            id: Date.now(),
            name: fullname,
            username: username,
            password: password,
            role: role,
            createdBy: currentUser.username,
            createdDate: new Date().toISOString()
        });
        showToast("User berhasil ditambahkan!", "success");
    }
    closeModal('modal-user');
    saveToLocalStorage();
    refreshAllData();
}

function renderUsers() {
    const tbody = document.querySelector('#table-users tbody');
    tbody.innerHTML = '';
    users.forEach(u => {
        const createdInfo = u.createdBy ? `<small class="user-process-info">Dibuat: ${new Date(u.createdDate).toLocaleDateString('id-ID')} oleh ${u.createdBy}</small>` : '';
        tbody.innerHTML += `
            <tr>
                <td>${u.username}</td>
                <td>${u.name}<br>${createdInfo}</td>
                <td>${u.role.toUpperCase()}</td>
                <td>${u.createdBy || 'System'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-warning btn-sm" onclick="editUser(${u.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${u.username !== 'owner' ? `
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>`;
    });
}

function deleteUser(id) {
    if(confirm('Hapus user ini?')) {
        users = users.filter(u => u.id !== id);
        saveToLocalStorage();
        refreshAllData();
        showToast("User berhasil dihapus!", "success");
    }
}

function editUser(id) {
    const u = users.find(x => x.id === id);
    document.getElementById('user-id').value = u.id;
    document.getElementById('user-fullname').value = u.name;
    document.getElementById('user-username').value = u.username;
    document.getElementById('user-password').value = u.password;
    document.getElementById('user-role').value = u.role;
    document.getElementById('modal-user').style.display = 'flex';
}

// --- INVENTORY ---
function renderInventory() {
    const tbody = document.querySelector('#table-inventory tbody');
    tbody.innerHTML = '';
    inventory.forEach(item => {
        const margin = item.price - item.cost;
        tbody.innerHTML += `
            <tr>
                <td><span class="clickable" onclick="openItemDetail(${item.id})">${item.name}</span></td>
                <td>${item.stock}</td>
                <td>${formatRupiah(item.cost)}</td>
                <td>${formatRupiah(item.price)}</td>
                <td style="color:var(--success)">+${formatRupiah(margin)}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openPurchaseModal(${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>`;
    });
    populateSelects();
    populateMutationDetailFilter();
}

function populateSelects() {
    const selects = [document.getElementById('trx-item'), document.getElementById('pur-item')];
    selects.forEach(sel => {
        sel.innerHTML = '';
        inventory.forEach(item => {
            sel.innerHTML += `<option value="${item.id}" data-price="${item.price}" data-cost="${item.cost}" data-name="${item.name}">${item.name}</option>`;
        });
    });
}

function populateMutationDetailFilter() {
    const select = document.getElementById('detail-filter-item');
    if (select) {
        select.innerHTML = '<option value="">Semua Barang</option>';
        inventory.forEach(item => {
            select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
        });
    }
}

function openItemDetail(itemId) {
    const item = inventory.find(i => i.id === itemId);
    if(!item) return;
    document.getElementById('detail-item-name').innerText = item.name;
    document.getElementById('detail-stock').innerText = item.stock;
    document.getElementById('detail-cost').innerText = formatRupiah(item.cost);
    document.getElementById('detail-price').innerText = formatRupiah(item.price);
    document.getElementById('detail-margin').innerText = formatRupiah(item.price - item.cost);
    document.getElementById('detail-edit-price').value = item.price;
    document.getElementById('detail-edit-stock').value = '';
    document.getElementById('modal-item-detail').setAttribute('data-item-id', itemId);
    renderDetailHistory(item);
    document.getElementById('modal-item-detail').style.display = 'flex';
}

function renderDetailHistory(item) {
    const tbody = document.getElementById('detail-history-body');
    tbody.innerHTML = '';
    let logs = [];
    
    // Gabungkan semua riwayat
    transactions.forEach(t => {
        t.items.forEach(ti => {
            if(ti.id === item.id) {
                logs.push({ 
                    date: new Date(t.date), 
                    type: 'OUT', 
                    ref: `Trx #${t.id} (${t.customer})`,
                    qty: -ti.qty, 
                    stockAfter: 0,
                    processedBy: t.processedBy || 'System'
                });
            }
        });
    });
    
    purchases.forEach(p => {
        if(p.itemId === item.id) {
            logs.push({ 
                date: new Date(p.date), 
                type: 'IN', 
                ref: `Beli/${p.note}`, 
                qty: p.qty, 
                stockAfter: 0,
                processedBy: p.processedBy || 'System'
            });
        }
    });
    
    logs.sort((a,b) => b.date - a.date);
    let currentStock = item.stock;
    
    logs.forEach(log => {
        log.stockAfter = currentStock;
        currentStock = currentStock - log.qty;
    });
    
    logs.forEach(log => {
        const dateStr = log.date.toLocaleDateString() + ' ' + log.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const color = log.type === 'OUT' ? 'var(--danger)' : 'var(--success)';
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td style="color:${color}; font-weight:bold;">${log.type}</td>
                <td>${log.ref}</td>
                <td style="color:var(--success)">${log.type === 'IN' ? log.qty : '-'}</td>
                <td style="color:var(--danger)">${log.type === 'OUT' ? Math.abs(log.qty) : '-'}</td>
                <td><strong>${log.stockAfter}</strong></td>
                <td><span class="user-process-badge">${log.processedBy}</span></td>
            </tr>`;
    });
    
    if(logs.length === 0) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Belum ada riwayat.</td></tr>';
}

function saveQuickEdit() {
    const modal = document.getElementById('modal-item-detail');
    const itemId = parseInt(modal.getAttribute('data-item-id'));
    const newPrice = parseInt(document.getElementById('detail-edit-price').value);
    const addStock = parseInt(document.getElementById('detail-edit-stock').value) || 0;
    const item = inventory.find(i => i.id === itemId);
    if(item) {
        if(newPrice) item.price = newPrice;
        if(addStock > 0) {
            item.stock += addStock;
            purchases.push({
                id: Date.now(),
                date: new Date().toISOString(),
                itemId: item.id,
                itemName: item.name,
                qty: addStock,
                cost: item.cost,
                note: 'Stok Manual',
                processedBy: currentUser.username
            });
        }
        closeModal('modal-item-detail');
        saveToLocalStorage();
        refreshAllData();
        showToast("Update Stok Berhasil", "success");
    }
}

// --- PURCHASE ---
function toggleNewItemInput() {
    const type = document.getElementById('pur-item-type').value;
    if(type === 'existing') {
        document.getElementById('pur-existing-group').classList.remove('hidden');
        document.getElementById('pur-edit-name-group').classList.remove('hidden');
        document.getElementById('pur-new-group').classList.add('hidden');
    } else {
        document.getElementById('pur-existing-group').classList.add('hidden');
        document.getElementById('pur-edit-name-group').classList.add('hidden');
        document.getElementById('pur-new-group').classList.remove('hidden');
    }
}

function openPurchaseModal(prefillId = null) {
    const modal = document.getElementById('modal-purchase');
    modal.style.display = 'flex';
    document.getElementById('pur-qty').value = '';
    document.getElementById('pur-cost').value = '';
    document.getElementById('pur-margin-amount').value = '';
    document.getElementById('pur-margin-percent').value = '';
    document.getElementById('pur-new-name').value = '';
    document.getElementById('pur-edit-name').value = '';
    document.getElementById('pur-item-type').value = 'existing';
    toggleNewItemInput();
    if(prefillId) {
        const item = inventory.find(i => i.id === prefillId);
        document.getElementById('pur-item').value = item.id;
        document.getElementById('pur-cost').value = item.cost;
    }
    ['pur-cost', 'pur-margin-amount', 'pur-margin-percent'].forEach(id => {
        document.getElementById(id).oninput = calculatePurchasePreview;
    });
    calculatePurchasePreview();
}

function calculatePurchasePreview() {
    const cost = parseInt(document.getElementById('pur-cost').value) || 0;
    const marginAmt = parseInt(document.getElementById('pur-margin-amount').value) || 0;
    const marginPct = parseInt(document.getElementById('pur-margin-percent').value) || 0;
    let finalPrice = cost;
    if(marginAmt > 0) finalPrice = cost + marginAmt;
    else if(marginPct > 0) finalPrice = cost + (cost * (marginPct / 100));
    document.getElementById('pur-preview-price').innerText = formatRupiah(finalPrice);
}

function submitPurchase() {
    const type = document.getElementById('pur-item-type').value;
    let item;
    const qty = parseInt(document.getElementById('pur-qty').value) || 0; 
    const cost = parseInt(document.getElementById('pur-cost').value) || 0;
    const marginAmt = parseInt(document.getElementById('pur-margin-amount').value) || 0;
    const marginPct = parseInt(document.getElementById('pur-margin-percent').value) || 0;
    const editName = document.getElementById('pur-edit-name').value.trim();
    const creditTerm = Math.random() > 0.7 ? 30 : 0; // 30% pembelian dengan kredit

    if(!cost) {
        showToast("Masukkan HPP!", "error");
        return;
    }

    if(type === 'new') {
        const newName = document.getElementById('pur-new-name').value;
        if(!newName) {
            showToast("Masukkan Nama Barang Baru!", "error");
            return;
        }
        const newItemId = Date.now();
        let finalPrice = cost;
        if(marginAmt > 0) finalPrice = cost + marginAmt;
        else if(marginPct > 0) finalPrice = cost + (cost * (marginPct / 100));
        
        inventory.push({ id: newItemId, name: newName, stock: qty, cost: cost, price: finalPrice });
        purchases.push({
            id: Date.now(),
            date: new Date().toISOString(),
            itemId: newItemId,
            itemName: newName,
            qty: qty,
            cost: cost,
            note: 'Baru',
            processedBy: currentUser.username,
            creditTerm: creditTerm
        });
        showToast("Barang baru berhasil ditambahkan!", "success");

    } else {
        const itemId = parseInt(document.getElementById('pur-item').value);
        item = inventory.find(x => x.id === itemId);
        if(editName) item.name = editName;

        if(qty > 0) item.stock += qty;
        item.cost = cost;
        if(marginAmt > 0) item.price = cost + marginAmt;
        else if(marginPct > 0) item.price = cost + (cost * (marginPct / 100));

        if(qty > 0) {
            purchases.push({
                id: Date.now(),
                date: new Date().toISOString(),
                itemId: item.id,
                itemName: editName || item.name,
                qty: qty,
                cost: cost,
                note: editName ? 'Ubah Nama & Beli' : 'Beli',
                processedBy: currentUser.username,
                creditTerm: creditTerm
            });
            showToast("Stok berhasil ditambahkan!", "success");
        } else if (editName) {
            purchases.push({
                id: Date.now(),
                date: new Date().toISOString(),
                itemId: item.id,
                itemName: editName,
                qty: 0,
                cost: cost,
                note: 'Ubah Nama',
                processedBy: currentUser.username
            });
            showToast("Nama barang berhasil diubah!", "success");
        } else {
            showToast("Data berhasil diupdate!", "success");
        }
    }
    closeModal('modal-purchase');
    saveToLocalStorage();
    refreshAllData();
}

// --- POS ---
function filterProductOptions() {
    const searchText = document.getElementById('trx-search').value.toLowerCase();
    const select = document.getElementById('trx-item');
    select.innerHTML = '';
    
    inventory.forEach(item => {
        if(item.name.toLowerCase().includes(searchText)) {
            const option = document.createElement('option');
            option.value = item.id;
            option.setAttribute('data-price', item.price);
            option.setAttribute('data-cost', item.cost);
            option.setAttribute('data-name', item.name);
            option.text = item.name + (item.stock < 10 ? ` (Stok: ${item.stock})` : '');
            select.appendChild(option);
        }
    });
}

function renderPOS() {
    const tbody = document.querySelector('#table-pos-history tbody');
    tbody.innerHTML = '';
    const sorted = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
    sorted.forEach(t => {
        const itemsSummary = t.items.map(i => `${i.name} (${i.qty})`).join(', ');
        let statusBadge = '';
        if (t.status === 'cash') statusBadge = '<span class="status-lunas">LUNAS</span>';
        else statusBadge = '<span class="status-belum">BELUM LUNAS</span>';
        let paidDateDisplay = '-';
        if (t.paidDate) paidDateDisplay = new Date(t.paidDate).toLocaleDateString('id-ID');
        const dateStr = new Date(t.date).toLocaleDateString('id-ID') + ' ' + new Date(t.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td>#${t.id}</td>
                <td>${t.customer}</td>
                <td style="font-size:0.8rem; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${itemsSummary}</td>
                <td>${formatRupiah(t.total)}</td>
                <td>${t.status === 'cash' ? 'CASH' : 'KREDIT'}</td>
                <td>
                    ${statusBadge}
                    ${t.paidDate ? `<br><small style="color:#666">Lunas: ${paidDateDisplay}</small>` : ''}
                </td>
                <td><span class="user-process-badge">${t.processedBy || 'System'}</span></td>
            </tr>`;
    });
}

function openTransaction() {
    currentCart = [];
    renderCart();
    document.getElementById('trx-customer').value = '';
    document.getElementById('trx-search').value = ''; 
    filterProductOptions();
    document.getElementById('trx-method').value = 'cash';
    document.getElementById('trx-cash-received').value = '';
    togglePaymentInput();
    document.getElementById('modal-transaction').style.display = 'flex';
}

function addToCart() {
    const select = document.getElementById('trx-item');
    if(select.selectedIndex === -1) {
        showToast("Pilih barang terlebih dahulu!", "error");
        return;
    }
    
    const itemId = parseInt(select.value);
    const itemName = select.options[select.selectedIndex].getAttribute('data-name');
    const itemCost = parseInt(select.options[select.selectedIndex].getAttribute('data-cost'));
    const itemPrice = parseInt(select.options[select.selectedIndex].getAttribute('data-price'));
    const qty = parseInt(document.getElementById('trx-qty').value);
    
    if(qty <= 0) {
        showToast("Jumlah harus lebih dari 0!", "error");
        return;
    }
    
    const item = inventory.find(i => i.id === itemId);
    if(item.stock < qty && item.stock < 100) { 
        showToast("Stok tidak cukup!", "error"); 
        return; 
    }
    
    currentCart.push({ id: itemId, name: itemName, cost: itemCost, price: itemPrice, qty: qty, subtotal: itemPrice * qty });
    renderCart();
    document.getElementById('trx-qty').value = 1;
    showToast("Barang ditambahkan ke keranjang!", "success");
}

function removeFromCart(index) { 
    currentCart.splice(index, 1); 
    renderCart();
    showToast("Barang dihapus dari keranjang!", "info");
}

function renderCart() {
    const container = document.getElementById('cart-container');
    container.innerHTML = '';
    let total = 0;
    if(currentCart.length === 0) { 
        container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">Keranjang Kosong</p>'; 
    } else {
        currentCart.forEach((item, index) => {
            total += item.subtotal;
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <div>
                    <strong>${item.name}</strong><br>
                    <small>${item.qty} x ${formatRupiah(item.price)}</small>
                </div>
                <div>
                    <div style="text-align:right">
                        <div>${formatRupiah(item.subtotal)}</div>
                        <button class="btn btn-danger btn-xs" style="padding:2px 5px;" onclick="removeFromCart(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>`;
            container.appendChild(div);
        });
    }
    document.getElementById('cart-total-display').innerText = 'Total: ' + formatRupiah(total);
    calculateChange();
}

function togglePaymentInput() {
    const method = document.getElementById('trx-method').value;
    const cashSection = document.getElementById('cash-payment-section');
    if (method === 'cash') cashSection.classList.remove('hidden');
    else cashSection.classList.add('hidden');
    calculateChange();
}

function calculateChange() {
    const method = document.getElementById('trx-method').value;
    const display = document.getElementById('change-display');
    if (method === 'credit') { 
        display.innerText = 'Kembalian: Rp 0 (KREDIT)'; 
        return; 
    }
    const cartTotal = currentCart.reduce((sum, item) => sum + item.subtotal, 0);
    const cashReceived = parseInt(document.getElementById('trx-cash-received').value) || 0;
    const change = cashReceived - cartTotal;
    if (change >= 0) { 
        display.innerText = 'Kembalian: ' + formatRupiah(change); 
        display.style.color = 'var(--success)'; 
    } else { 
        display.innerText = 'Kurang: ' + formatRupiah(Math.abs(change)); 
        display.style.color = 'var(--danger)'; 
    }
}

function submitTransaction() {
    if(currentCart.length === 0) {
        showToast("Keranjang kosong!", "error");
        return;
    }
    
    const customer = document.getElementById('trx-customer').value || 'Umum';
    const method = document.getElementById('trx-method').value;
    const cartTotal = currentCart.reduce((sum, item) => sum + item.subtotal, 0);
    const cartCost = currentCart.reduce((sum, item) => sum + (item.cost * item.qty), 0);

    if (method === 'cash') {
        const cashReceived = parseInt(document.getElementById('trx-cash-received').value) || 0;
        if (cashReceived < cartTotal) {
            showToast("Uang tunai kurang!", "error");
            return;
        }
    }

    currentCart.forEach(cartItem => {
        const item = inventory.find(i => i.id === cartItem.id);
        if(item.stock < 100) item.stock -= cartItem.qty;
    });

    transactions.push({
        id: Date.now(),
        date: new Date().toISOString(),
        customer: customer,
        items: [...currentCart],
        total: cartTotal,
        costTotal: cartCost,
        status: method,
        paidDate: method === 'cash' ? new Date().toISOString() : null,
        processedBy: currentUser.username
    });
    
    showToast("Transaksi Berhasil!", "success");
    closeModal('modal-transaction');
    saveToLocalStorage();
    refreshAllData();
}

function payDebt(id) {
    if(confirm('Lunasi tagihan ini sekarang?')) {
        const t = transactions.find(x => x.id === id);
        if(t) { 
            t.status = 'cash'; 
            t.paidDate = new Date().toISOString(); 
            t.processedBy = currentUser.username + ' (Pelunasan)';
            saveToLocalStorage();
            refreshAllData(); 
            showToast("Tagihan dilunasi.", "success");
        }
    }
}

function viewTransactionDetail(id) {
    const t = transactions.find(x => x.id === id);
    if(t) {
        alert(`Detail Transaksi #${t.id}\n\n` +
              `Pelanggan: ${t.customer}\n` +
              `Tanggal: ${new Date(t.date).toLocaleString('id-ID')}\n` +
              `Status: ${t.status === 'cash' ? 'LUNAS' : 'BELUM LUNAS'}\n` +
              `Total: ${formatRupiah(t.total)}\n\n` +
              `Item:\n${t.items.map(i => `- ${i.name} (${i.qty} x ${formatRupiah(i.price)})`).join('\n')}`);
    }
}

// --- DASHBOARD KASIR ---
function renderDashboardKasir() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const todaySales = transactions
        .filter(t => {
            const tDate = new Date(t.date);
            return tDate >= today && tDate < tomorrow && t.status === 'cash';
        })
        .reduce((sum, t) => sum + t.total, 0);
    
    const activeReceivables = transactions
        .filter(t => t.status === 'credit')
        .reduce((sum, t) => sum + t.total, 0);
    
    const todayTransactions = transactions
        .filter(t => {
            const tDate = new Date(t.date);
            return tDate >= today && tDate < tomorrow;
        })
        .length;
    
    document.getElementById('dash-sales-today').innerText = formatRupiah(todaySales);
    document.getElementById('dash-receivable-active').innerText = formatRupiah(activeReceivables);
    document.getElementById('dash-transactions-today').innerText = todayTransactions;
    
    const tbody = document.querySelector('#table-due-receivables-kasir tbody');
    tbody.innerHTML = '';
    
    const creditTransactions = transactions.filter(t => t.status === 'credit');
    
    if (creditTransactions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align:center; padding: 2rem;">
                    <i class="fas fa-check-circle" style="color:var(--secondary); font-size:2rem; margin-bottom:1rem; display:block;"></i>
                    <p>Tidak ada tagihan yang belum lunas</p>
                </td>
            </tr>`;
    } else {
        creditTransactions.forEach(t => {
            const transDate = new Date(t.date);
            const dueDate = new Date(transDate);
            dueDate.setDate(dueDate.getDate() + 30); // Jatuh tempo 30 hari
            
            const dateStr = transDate.toLocaleDateString('id-ID');
            const dueDateStr = dueDate.toLocaleDateString('id-ID');
            
            tbody.innerHTML += `
                <tr>
                    <td>${t.customer.substring(0, 15)}${t.customer.length > 15 ? '...' : ''}</td>
                    <td>#${t.id}</td>
                    <td>${formatRupiah(t.total)}</td>
                    <td>${dueDateStr}</td>
                    <td><span class="user-process-badge">${t.processedBy || 'System'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-success btn-xs" onclick="payDebt(${t.id})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-primary btn-xs" onclick="viewTransactionDetail(${t.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
    }
}

// --- LAPORAN PEMBELIAN ---
function renderPurchaseReport() {
    const startStr = document.getElementById('pur-filter-start').value;
    const endStr = document.getElementById('pur-filter-end').value;
    const tbody = document.querySelector('#table-purchase-report tbody');
    tbody.innerHTML = '';
    
    if(!startStr || !endStr) { 
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Silakan pilih rentang tanggal.</td></tr>'; 
        return; 
    }
    
    const startDate = new Date(startStr);
    const endDate = new Date(endStr);
    endDate.setHours(23, 59, 59, 999);

    const filtered = purchases.filter(p => {
        const d = new Date(p.date);
        return d >= startDate && d <= endDate;
    });

    let totalPurchase = 0;
    let totalQty = 0;
    let uniqueItems = new Set();

    filtered.forEach(p => {
        const dateStr = new Date(p.date).toLocaleDateString('id-ID');
        const totalModal = p.qty * p.cost;
        totalPurchase += totalModal;
        totalQty += p.qty;
        uniqueItems.add(p.itemId);
        
        const paymentMethod = p.creditTerm ? `Kredit (${p.creditTerm} hari)` : 'Cash';
        
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td>${p.itemName}</td>
                <td>${p.qty}</td>
                <td>${formatRupiah(p.cost)}</td>
                <td>${formatRupiah(totalModal)}</td>
                <td>${paymentMethod}</td>
                <td><span class="user-process-badge">${p.processedBy || 'System'}</span></td>
            </tr>`;
    });
    
    document.getElementById('total-purchase-summary').innerText = formatRupiah(totalPurchase);
    document.getElementById('total-purchase-qty').innerText = totalQty;
    document.getElementById('total-purchase-items').innerText = uniqueItems.size;
    
    if(filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Tidak ada data pembelian pada periode ini.</td></tr>';
    }
}

// --- LAPORAN PENJUALAN ---
function renderSalesReport() {
    const startStr = document.getElementById('sales-filter-start').value;
    const endStr = document.getElementById('sales-filter-end').value;
    const tbody = document.querySelector('#table-sales-report tbody');
    tbody.innerHTML = '';
    
    if(!startStr || !endStr) { 
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Silakan pilih rentang tanggal.</td></tr>'; 
        return; 
    }
    
    const startDate = new Date(startStr);
    const endDate = new Date(endStr);
    endDate.setHours(23, 59, 59, 999);

    const filtered = transactions.filter(t => {
        const d = new Date(t.date);
        return d >= startDate && d <= endDate;
    });

    let totalSales = 0;
    let totalCredit = 0;
    let totalTransactions = filtered.length;

    filtered.forEach(t => {
        const itemsSummary = t.items.map(i => `${i.name} (${i.qty})`).join(', ');
        let statusBadge = t.status === 'cash' ? '<span class="status-lunas">LUNAS</span>' : '<span class="status-belum">BELUM</span>';
        const dateStr = new Date(t.date).toLocaleDateString('id-ID');
        
        totalSales += t.total;
        if(t.status === 'credit') totalCredit += t.total;
        
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td>#${t.id}</td>
                <td>${t.customer.substring(0, 15)}${t.customer.length > 15 ? '...' : ''}</td>
                <td style="font-size:0.8rem; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${itemsSummary}</td>
                <td>${t.status.toUpperCase()}</td>
                <td>${formatRupiah(t.total)}</td>
                <td>${statusBadge}</td>
                <td><span class="user-process-badge">${t.processedBy || 'System'}</span></td>
            </tr>`;
    });
    
    document.getElementById('total-sales-summary').innerText = formatRupiah(totalSales);
    document.getElementById('total-credit-summary').innerText = formatRupiah(totalCredit);
    document.getElementById('total-transactions-summary').innerText = totalTransactions;
    
    if(filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Tidak ada data penjualan pada periode ini.</td></tr>';
    }
}

// --- MUTATION REPORT ---
function renderMutationReport() {
    const startStr = document.getElementById('filter-start').value;
    const endStr = document.getElementById('filter-end').value;
    const tbody = document.querySelector('#table-opname tbody');
    tbody.innerHTML = '';
    
    if(!startStr || !endStr) { 
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center">Silakan pilih rentang tanggal.</td></tr>'; 
        return; 
    }
    
    const startDate = new Date(startStr);
    const endDate = new Date(endStr);
    endDate.setHours(23, 59, 59, 999);

    inventory.forEach(item => {
        let totalIn = 0;
        let totalOut = 0;
        let outTransactions = []; 

        purchases.forEach(p => {
            const pDate = new Date(p.date);
            if (pDate >= startDate && pDate <= endDate && p.itemId === item.id) {
                totalIn += p.qty;
            }
        });

        transactions.forEach(t => {
            const tDate = new Date(t.date);
            if (tDate >= startDate && tDate <= endDate) {
                t.items.forEach(trxItem => { 
                    if(trxItem.id === item.id) { 
                        totalOut += trxItem.qty; 
                        outTransactions.push(t); 
                    } 
                });
            }
        });
        
        let opnameRecord = stockOpname.find(o => o.itemId === item.id && o.periodStart === startStr && o.periodEnd === endStr);
        if (!opnameRecord) {
            opnameRecord = {
                id: Date.now(),
                itemId: item.id,
                itemName: item.name,
                periodStart: startStr,
                periodEnd: endStr,
                actual: '',
                remarks: '',
                processedBy: currentUser.username,
                processedDate: new Date().toISOString()
            };
            stockOpname.push(opnameRecord);
        }
        
        const stockAwal = item.stock + totalOut - totalIn;
        const stockSistem = stockAwal + totalIn - totalOut;
        const actual = opnameRecord.actual || '';
        const selisih = actual !== '' ? (parseInt(actual) || 0) - stockSistem : 0;
        const remarks = opnameRecord.remarks || '';
        const processedBy = opnameRecord.processedBy || 'Belum diopname';

        let selisihClass = 'selisih-zero';
        if (selisih > 0) selisihClass = 'selisih-positive';
        else if (selisih < 0) selisihClass = 'selisih-negative';

        let selisihDisplay = '-';
        if (actual !== '') {
            selisihDisplay = selisih > 0 ? `+${selisih}` : selisih;
            
            if (selisih < 0 && !opnameRecord.expenseCreated) {
                createStockLossExpense(item, Math.abs(selisih), startStr, endStr, opnameRecord);
                opnameRecord.expenseCreated = true;
            }
        }

        const outDisplay = totalOut > 0 ? `<span class="clickable" onclick="showMutationDetail('${item.name}', ${totalOut})">${totalOut}</span>` : totalOut;

        tbody.innerHTML += `
            <tr>
                <td style="text-align:left">${item.name}</td>
                <td>${stockAwal}</td>
                <td style="color:var(--success); font-weight:bold;">${totalIn}</td>
                <td style="color:var(--danger); font-weight:bold;">${outDisplay}</td>
                <td style="font-weight:bold;">${stockSistem}</td>
                <td>
                    <input type="number" 
                           class="table-input" 
                           value="${actual}" 
                           onchange="updateActualStock(${item.id}, '${startStr}', '${endStr}', this.value)"
                           placeholder="Actual">
                </td>
                <td class="${selisihClass}">${selisihDisplay}</td>
                <td>
                    <div class="flex-align-center">
                        <input type="text" 
                               class="remarks-input" 
                               value="${remarks}" 
                               onchange="updateRemarks(${item.id}, '${startStr}', '${endStr}', this.value)"
                               placeholder="Keterangan">
                        ${remarks ? `
                            <button class="btn btn-danger btn-xs" onclick="deleteRemarks(${item.id}, '${startStr}', '${endStr}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
                <td><span class="user-process-badge">${processedBy}</span></td>
                <td>
                    <button class="btn btn-primary btn-xs" onclick="saveStockOpname(${item.id}, '${startStr}', '${endStr}')">
                        <i class="fas fa-save"></i>
                    </button>
                </td>
            </tr>`;
    });
}

function createStockLossExpense(item, qty, startDate, endDate, opnameRecord) {
    const totalLoss = qty * item.cost;
    const expenseDesc = `Stock Loss - ${item.name} (${qty} unit) - Periode ${startDate} s/d ${endDate}`;
    
    const existingExpense = expenses.find(e => 
        e.desc.includes(`Stock Loss - ${item.name}`) && 
        e.desc.includes(`Periode ${startDate}`)
    );
    
    if (!existingExpense) {
        expenses.push({
            id: Date.now(),
            date: new Date().toISOString(),
            desc: expenseDesc,
            amount: totalLoss,
            type: 'stock_loss',
            processedBy: currentUser.username,
            itemId: item.id,
            qty: qty,
            periodStart: startDate,
            periodEnd: endDate
        });
        
        showToast(`Beban biaya loss untuk ${item.name} sebesar ${formatRupiah(totalLoss)} telah dicatat`, "warning");
        
        opnameRecord.lossAmount = totalLoss;
        opnameRecord.lossQty = qty;
        opnameRecord.expenseCreated = true;
    }
}

function updateActualStock(itemId, startDate, endDate, value) {
    let opnameRecord = stockOpname.find(o => o.itemId === itemId && o.periodStart === startDate && o.periodEnd === endDate);
    if (!opnameRecord) {
        const item = inventory.find(i => i.id === itemId);
        opnameRecord = {
            id: Date.now(),
            itemId: itemId,
            itemName: item.name,
            periodStart: startDate,
            periodEnd: endDate,
            actual: value,
            remarks: '',
            processedBy: currentUser.username,
            processedDate: new Date().toISOString()
        };
        stockOpname.push(opnameRecord);
    } else {
        opnameRecord.actual = value;
        opnameRecord.processedBy = currentUser.username;
        opnameRecord.processedDate = new Date().toISOString();
    }
    
    const item = inventory.find(i => i.id === itemId);
    if (item && value !== '') {
        let totalIn = 0;
        let totalOut = 0;
        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);
        endDateObj.setHours(23, 59, 59, 999);
        
        purchases.forEach(p => {
            const pDate = new Date(p.date);
            if (pDate >= startDateObj && pDate <= endDateObj && p.itemId === itemId) {
                totalIn += p.qty;
            }
        });
        
        transactions.forEach(t => {
            const tDate = new Date(t.date);
            if (tDate >= startDateObj && tDate <= endDateObj) {
                t.items.forEach(trxItem => { 
                    if(trxItem.id === itemId) { 
                        totalOut += trxItem.qty; 
                    } 
                });
            }
        });
        
        const stockAwal = item.stock + totalOut - totalIn;
        const stockSistem = stockAwal + totalIn - totalOut;
        const selisih = parseInt(value) - stockSistem;
        
        if (selisih < 0 && !opnameRecord.expenseCreated) {
            createStockLossExpense(item, Math.abs(selisih), startDate, endDate, opnameRecord);
        }
    }
    
    renderMutationReport();
    renderExpenses();
}

function updateRemarks(itemId, startDate, endDate, value) {
    let opnameRecord = stockOpname.find(o => o.itemId === itemId && o.periodStart === startDate && o.periodEnd === endDate);
    if (!opnameRecord) {
        const item = inventory.find(i => i.id === itemId);
        opnameRecord = {
            id: Date.now(),
            itemId: itemId,
            itemName: item.name,
            periodStart: startDate,
            periodEnd: endDate,
            actual: '',
            remarks: value,
            processedBy: currentUser.username,
            processedDate: new Date().toISOString()
        };
        stockOpname.push(opnameRecord);
    } else {
        opnameRecord.remarks = value;
        opnameRecord.processedBy = currentUser.username;
        opnameRecord.processedDate = new Date().toISOString();
    }
}

function deleteRemarks(itemId, startDate, endDate) {
    let opnameRecord = stockOpname.find(o => o.itemId === itemId && o.periodStart === startDate && o.periodEnd === endDate);
    if (opnameRecord) {
        opnameRecord.remarks = '';
        showToast("Remarks dihapus", "info");
        renderMutationReport();
    }
}

function saveStockOpname(itemId, startDate, endDate) {
    let opnameRecord = stockOpname.find(o => o.itemId === itemId && o.periodStart === startDate && o.periodEnd === endDate);
    if (opnameRecord) {
        showToast("Data stock opname disimpan", "success");
        saveToLocalStorage();
    }
}

// --- DETAIL MUTASI STOK ---
function renderMutationDetail() {
    const startStr = document.getElementById('detail-filter-start').value;
    const endStr = document.getElementById('detail-filter-end').value;
    const itemFilter = document.getElementById('detail-filter-item').value;
    const tbody = document.querySelector('#table-mutation-detail tbody');
    tbody.innerHTML = '';
    
    if(!startStr || !endStr) { 
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Silakan pilih rentang tanggal.</td></tr>'; 
        return; 
    }
    
    const startDate = new Date(startStr);
    const endDate = new Date(endStr);
    endDate.setHours(23, 59, 59, 999);

    let mutationLogs = [];

    purchases.forEach(p => {
        const pDate = new Date(p.date);
        if (pDate >= startDate && pDate <= endDate) {
            const item = inventory.find(i => i.id === p.itemId);
            if (item && (!itemFilter || item.id == itemFilter)) {
                mutationLogs.push({
                    date: p.date,
                    itemName: p.itemName,
                    type: 'IN',
                    reference: `Pembelian - ${p.note}`,
                    qty: p.qty,
                    stockBefore: item.stock - p.qty,
                    stockAfter: item.stock,
                    processedBy: p.processedBy || 'System'
                });
            }
        }
    });

    transactions.forEach(t => {
        const tDate = new Date(t.date);
        if (tDate >= startDate && tDate <= endDate) {
            t.items.forEach(trxItem => {
                const item = inventory.find(i => i.id === trxItem.id);
                if (item && (!itemFilter || item.id == itemFilter)) {
                    mutationLogs.push({
                        date: t.date,
                        itemName: trxItem.name,
                        type: 'OUT',
                        reference: `Penjualan #${t.id} - ${t.customer}`,
                        qty: trxItem.qty,
                        stockBefore: item.stock + trxItem.qty,
                        stockAfter: item.stock,
                        processedBy: t.processedBy || 'System'
                    });
                }
            });
        }
    });

    mutationLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

    if (mutationLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Tidak ada data mutasi pada periode ini.</td></tr>';
        return;
    }

    mutationLogs.forEach(log => {
        const dateStr = new Date(log.date).toLocaleDateString('id-ID') + ' ' + 
                       new Date(log.date).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        const typeColor = log.type === 'IN' ? 'var(--success)' : 'var(--danger)';
        
        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td>${log.itemName}</td>
                <td style="color:${typeColor}; font-weight:bold;">${log.type}</td>
                <td>${log.reference}</td>
                <td style="font-weight:bold; color:${typeColor}">${log.type === 'IN' ? '+' : '-'}${log.qty}</td>
                <td>${log.stockBefore}</td>
                <td>${log.stockAfter}</td>
                <td><span class="user-process-badge">${log.processedBy}</span></td>
            </tr>`;
    });
}

function showMutationDetail(itemName, totalOut) {
    document.getElementById('mut-item-name').innerText = itemName;
    document.getElementById('mut-total-out').innerText = totalOut;
    const listDiv = document.getElementById('mut-list');
    listDiv.innerHTML = '';
    let found = false;
    transactions.forEach(t => {
        t.items.forEach(ti => {
            if(ti.name === itemName) {
                found = true;
                const dateStr = new Date(t.date).toLocaleDateString() + ' ' + new Date(t.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <strong>#${t.id} - ${t.customer}</strong>
                        <span style="color:var(--danger)">-${ti.qty}</span>
                    </div>
                    <small>${dateStr} | Oleh: ${t.processedBy || 'System'}</small>`;
                listDiv.appendChild(div);
            }
        });
    });
    if(!found) listDiv.innerHTML = '<p style="text-align:center; color:#999">Tidak ada data transaksi ditemukan.</p>';
    document.getElementById('modal-mutation-detail').style.display = 'flex';
}

// --- EXPENSES ---
function renderExpenses() {
    const tbody = document.querySelector('#table-expenses tbody');
    tbody.innerHTML = '';
    expenses.forEach(e => { 
        const processedInfo = e.processedBy ? `<small class="user-process-info">Oleh: ${e.processedBy}</small>` : '';
        tbody.innerHTML += `
            <tr>
                <td>${new Date(e.date).toLocaleDateString()}</td>
                <td>${e.desc.substring(0, 30)}${e.desc.length > 30 ? '...' : ''}<br>${processedInfo}</td>
                <td>${formatRupiah(e.amount)}</td>
                <td><span class="user-process-badge">${e.processedBy || 'System'}</span></td>
                <td>
                    <button class="btn btn-danger btn-xs" onclick="deleteExpense(${e.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`; 
    });
}

function openExpenseModal() { 
    document.getElementById('modal-expense').style.display = 'flex'; 
}

function submitExpense() {
    const desc = document.getElementById('exp-desc').value;
    const amt = parseInt(document.getElementById('exp-amount').value);
    if(!desc || !amt) {
        showToast("Isi semua data!", "error");
        return;
    }
    expenses.push({ 
        id: Date.now(), 
        date: new Date().toISOString(), 
        desc: desc, 
        amount: amt,
        processedBy: currentUser.username
    });
    closeModal('modal-expense'); 
    saveToLocalStorage();
    refreshAllData();
    showToast("Pengeluaran berhasil dicatat!", "success");
}

function deleteExpense(id) { 
    if(confirm('Hapus pengeluaran ini?')) { 
        expenses = expenses.filter(e => e.id !== id); 
        saveToLocalStorage();
        refreshAllData(); 
        showToast("Pengeluaran dihapus!", "success");
    } 
}

// --- DASHBOARD OVERVIEW ---
function renderDashboard() {
    const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
    const debt = transactions.filter(t => t.status === 'credit').reduce((sum, t) => sum + t.total, 0);
    const totalCOGS = transactions.reduce((sum, t) => sum + t.costTotal, 0);
    const totalExp = expenses.reduce((sum, e) => sum + e.amount, 0);
    const profit = (totalSales - totalCOGS) - totalExp;
    document.getElementById('dash-sales').innerText = formatRupiah(totalSales);
    document.getElementById('dash-receivable').innerText = formatRupiah(debt);
    document.getElementById('dash-profit').innerText = formatRupiah(profit);
    
    const tbody = document.querySelector('#table-due-receivables tbody');
    tbody.innerHTML = '';
    const debts = transactions.filter(t => t.status === 'credit');
    debts.forEach(t => {
        const dateStr = new Date(t.date).toLocaleDateString();
        tbody.innerHTML += `
            <tr>
                <td>${t.customer.substring(0, 15)}${t.customer.length > 15 ? '...' : ''}</td>
                <td>${formatRupiah(t.total)}</td>
                <td>${dateStr}</td>
                <td><span class="user-process-badge">${t.processedBy || 'System'}</span></td>
                <td>
                    <button class="btn btn-success btn-xs" onclick="payDebt(${t.id})">
                        <i class="fas fa-check"></i>
                    </button>
                </td>
            </tr>`;
    });
}

// --- LABA RUGI ---
function renderReports() {
    const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
    const totalCOGS = transactions.reduce((sum, t) => sum + t.costTotal, 0);
    const totalExp = expenses.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('report-revenue').innerText = formatRupiah(totalSales);
    document.getElementById('report-cogs').innerText = formatRupiah(totalCOGS);
    document.getElementById('report-gross').innerText = formatRupiah(totalSales - totalCOGS);
    document.getElementById('report-expenses').innerText = formatRupiah(totalExp);
    document.getElementById('report-net').innerText = formatRupiah((totalSales - totalCOGS) - totalExp);
}

// --- UTILS ---
function formatRupiah(num) { 
    if (!num) return 'Rp 0';
    return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
    resetIdleTimer();
}

function exportTableToExcel(tableID, filename = ''){
    let downloadLink;
    const dataType = 'application/vnd.ms-excel';
    const tableSelect = document.getElementById(tableID);
    const tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    
    downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    
    if(navigator.msSaveOrOpenBlob){
        const blob = new Blob(['\ufeff', tableHTML], { type: dataType });
        navigator.msSaveOrOpenBlob(blob, filename);
    }else{
        downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
        downloadLink.download = filename + '.xls';
        downloadLink.click();
    }
    
    document.body.removeChild(downloadLink);
    showToast("Laporan berhasil diunduh", "success");
}

function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    const icon = toast.querySelector('.toast-icon');
    const msg = toast.querySelector('.toast-message');
    
    switch(type) {
        case "success":
            icon.innerHTML = '<i class="fas fa-check-circle"></i>';
            break;
        case "error":
            icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            break;
        case "warning":
            icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            break;
        case "info":
            icon.innerHTML = '<i class="fas fa-info-circle"></i>';
            break;
    }
    
    msg.innerText = message;
    toast.className = "toast show";
    
    setTimeout(function(){ 
        toast.className = toast.className.replace("show", ""); 
    }, 3000);
    resetIdleTimer();
}

function refreshAllData() { 
    renderInventory(); 
    renderSalesReport(); 
    renderPurchaseReport(); 
    renderMutationReport(); 
    renderMutationDetail();
    renderPOS(); 
    renderExpenses(); 
    renderReports(); 
    renderDashboard(); 
    renderUsers();
    
    if (currentUser && currentUser.role === 'cashier') {
        renderDashboardKasir();
    }
}

// --- INITIALIZE ---
window.onload = function() {
    createFloatingIcons();
    
    // Set tanggal default untuk filter
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const dateInputs = [
        'sales-filter-start', 'sales-filter-end',
        'pur-filter-start', 'pur-filter-end',
        'filter-start', 'filter-end',
        'detail-filter-start', 'detail-filter-end'
    ];
    
    dateInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.value = today.toISOString().split('T')[0];
        }
    });
    
    // Inisialisasi select inventory
    populateSelects();
    populateMutationDetailFilter();
    
    // Check jika device touch
    if ('ontouchstart' in window || navigator.maxTouchPoints) {
        document.body.classList.add('touch-device');
    }
    
    // Handle orientation change
    window.addEventListener('orientationchange', function() {
        setTimeout(refreshAllData, 200);
    });
    
    // Auto-save setiap 30 detik
    setInterval(saveToLocalStorage, 30000);
    
    // Save sebelum unload
    window.addEventListener('beforeunload', function() {
        saveToLocalStorage();
    });
    
    console.log('Data loaded from Local Storage:', {
        users: users.length,
        inventory: inventory.length,
        transactions: transactions.length,
        expenses: expenses.length,
        purchases: purchases.length,
        stockOpname: stockOpname.length
    });
};

// Handle klik di luar modal untuk close
window.onclick = function(e) { 
    if (e.target.classList.contains('modal')) {
        e.target.style.display = "none"; 
    }
    resetIdleTimer();
}

// Handle keyboard untuk mobile
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            setTimeout(() => {
                this.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        });
    });
    
    // Prevent zoom on double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
});
</script>
</body>
</html>
